<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farming Simulator</title>
    <style>
        body { font-family: Arial, sans-serif; background: #e6ffe6; margin: 0; padding: 0; }
        .container { max-width: 900px; margin: 40px auto; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px #aaa; padding: 24px; }
        h1 { text-align: center; }
        .field { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 20px 0; }
        .plot { width: 60px; height: 60px; background: #b3e6b3; border: 2px solid #6c9e6c; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 24px; transition: background 0.2s; }
        .plot.empty { background: #b3e6b3; }
        .plot.wheat-planted { background: #ffe066; }
        .plot.wheat-grown { background: #ffb347; }
        .plot.carrot-planted { background: #f9c784; }
        .plot.carrot-grown { background: #ff914d; }
        .plot.tomato-planted { background: #ffb3b3; }
        .plot.tomato-grown { background: #ff4d4d; }
        .controls, .shop, .achievements, .pets, .characters { text-align: center; margin-top: 20px; }
        button { padding: 8px 16px; font-size: 16px; border-radius: 5px; border: none; background: #4caf50; color: #fff; cursor: pointer; margin: 0 5px; }
        button:disabled { background: #aaa; }
        button.cook-available {
            background: #43d15c !important;
            border: 2px solid #2e8b3a !important;
            color: #fff;
        }
        .stats { text-align: center; margin-top: 20px; }
        .shop { background: #e0ffe0; border-radius: 8px; padding: 10px; margin: 20px 0; }
        .achievements { background: #fffbe0; border-radius: 8px; padding: 10px; margin: 20px 0; }
        .pets, .characters { background: #e0f7ff; border-radius: 8px; padding: 10px; margin: 20px 0; }
        .pet, .character { display: inline-block; margin: 0 10px; font-size: 32px; }
        .cosmetics { text-align: center; margin-top: 20px; }
        .field-controls { text-align: center; margin: 20px 0; }
        .order { background: #fff3cd; border: 1px solid #ffeeba; border-radius: 8px; padding: 10px; margin: 10px 0; }
        .energy-bar { margin: 10px auto; width: 300px; height: 24px; background: #eee; border-radius: 12px; overflow: hidden; border: 1px solid #aaa; }
        .energy-fill { height: 100%; background: linear-gradient(90deg,#4caf50,#a8e063); transition: width 0.3s; }
        .player { text-align: center; font-size: 40px; margin: 10px 0; }
        .recipes { background: #fff0e0; border-radius: 8px; padding: 10px; margin: 20px 0; }
        .intro-modal { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.6); z-index: 9999; align-items: center; justify-content: center; pointer-events: all; }
        .intro-modal > div { background: #fff; padding: 32px 24px; border-radius: 12px; max-width: 400px; margin: auto; text-align: center; z-index: 10000; pointer-events: all; }
        #emojiPicker button { font-size: 28px; margin: 4px; cursor: pointer; z-index: 10001; pointer-events: all; }
        #notification { display:none; position:fixed; top:30px; left:50%; transform:translateX(-50%); background:#4caf50; color:#fff; padding:12px 32px; border-radius:8px; box-shadow:0 2px 8px #aaa; font-size:18px; z-index:10001; pointer-events:none; transition:opacity 0.4s; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Farming Simulator</h1>
        <div id="notification"></div>
        <div id="fieldControls" class="field-controls"></div>
        <div id="field" class="field"></div>
        <div id="stats" class="stats"></div>
        <div id="energyBar" class="energy-bar"></div>
        <div class="controls">
            <button onclick="waterCrops()">Water Crops</button>
            <button onclick="harvestCrops()">Harvest Crops</button>
            <button onclick="showInventory()">Show Inventory</button>
            <button onclick="showSellBin()">Show Sell Bin</button>
        </div>
        <div id="shop" class="shop"></div>
        <div id="orders" class="orders"></div>
        <div id="recipes" class="recipes"></div>
        <div id="achievements" class="achievements"></div>
        <div id="pets" class="pets"></div>
        <div id="characters" class="characters"></div>
        <div id="cosmetics" class="cosmetics"></div>
        <div id="avatarPetControls"></div>
        <div id="progressBarContainer" style="margin:20px 0;">
            <div id="progressBar" style="width:100%;height:8px;background:#4caf50;border-radius:4px;"></div>
        </div>
        <div class="field-controls" id="fieldControls"></div>
        <div class="controls">
            <button onclick="switchField(0)">Field 1</button>
            <button onclick="switchField(1)">Field 2</button>
            <button onclick="switchField(2)">Field 3</button>
        </div>
        <div id="seedMenu" style="display:none;position:absolute;background:#fff;border:1px solid #aaa;border-radius:6px;padding:6px;z-index:10;"></div>
    </div>
    <div class="intro-modal" id="introModal">
        <div>
            <h2>Welcome to Farming Simulator!</h2>
            <p>Use WASD or arrow keys to move around. Plant seeds, water crops, and harvest them to earn money!</p>
            <button onclick="closeIntro()">Got it!</button>
        </div>
    </div>
    <script>
        // Emoji options for player
        const playerEmojis = ['üßë‚Äçüåæ','üë©‚Äçüåæ','üë®‚Äçüåæ','ü¶∏','üßô','üßë‚Äçüç≥','üßë‚ÄçüöÄ','üßë‚Äçüé®','üßë‚Äçüî¨','üßë‚Äçüíª','ü¶Ñ','üê±','üê∂','üê∞','üêª','üê∏'];
        // Crop definitions
        const crops = {
            wheat: { name: 'Wheat', emoji: 'üåæ', seedEmoji: 'üå±', price: 5, sell: 10, growTime: 1 },
            carrot: { name: 'Carrot', emoji: 'ü•ï', seedEmoji: 'üå±', price: 10, sell: 20, growTime: 2 },
            tomato: { name: 'Tomato', emoji: 'üçÖ', seedEmoji: 'üå±', price: 15, sell: 30, growTime: 3 },
            corn: { name: 'Corn', emoji: 'üåΩ', seedEmoji: 'üå±', price: 12, sell: 25, growTime: 2 },
            potato: { name: 'Potato', emoji: 'ü•î', seedEmoji: 'üå±', price: 8, sell: 18, growTime: 2 },
            lettuce: { name: 'Lettuce', emoji: 'ü•¨', seedEmoji: 'üå±', price: 7, sell: 15, growTime: 1 }
        };
        // Multiple fields support
        const numFields = 3;
        const fieldSize = 25;
        let fields = Array(numFields).fill(null).map(() => Array(fieldSize).fill(null));
        let currentField = 0;
        let growthTimers = Array(numFields).fill(null).map(() => Array(fieldSize).fill(0));
        // Inventory and state
        let seeds = { wheat: 3, carrot: 0, tomato: 0, corn: 0, potato: 0, lettuce: 0 };
        let money = 20;
        let harvest = 0;
        let achievements = [];
        let pets = [];
        let characters = [];
        let cosmetics = { hats: [], backgrounds: [], equippedHat: null, equippedBg: null };
        // Orders system
        let orders = [];
        let orderId = 1;

        // Add missing variable declaration for player
        let player = { emoji: '', pos: 12, energy: 100, maxEnergy: 100 };

        // Generate a new random order
        function generateOrder() {
            // Pick a random crop type
            const cropTypes = Object.keys(crops);
            const type = cropTypes[Math.floor(Math.random() * cropTypes.length)];
            // Amount between 2 and 5
            const amount = Math.floor(Math.random() * 4) + 2;
            // Reward is crop sell price * amount + bonus
            const reward = crops[type].sell * amount + Math.floor(Math.random() * 10 + 5);
            orders.push({ id: orderId++, type, amount, reward });
        }

        // Ensure at least one order exists at all times
        function ensureOrders() {
            if (orders.length === 0) {
                generateOrder();
                renderOrders();
            }
        }

        // Achievements definitions
        const achievementList = [
            { id: 'firstHarvest', name: 'First Harvest', desc: 'Harvest your first crop!', unlock: 'pet', pet: 'üê∂', reward: { money: 10, seeds: { wheat: 2 } } },
            { id: 'wheatMaster', name: 'Wheat Master', desc: 'Harvest 10 wheat!', unlock: 'character', character: { emoji: 'üë©‚Äçüåæ', name: 'Farmer Jill', text: 'Keep up the good work!' }, reward: { money: 30, seeds: { wheat: 3 } } },
            { id: 'carrotKing', name: 'Carrot King', desc: 'Harvest 10 carrots!', unlock: 'pet', pet: 'üê∞', reward: { money: 30, seeds: { carrot: 3 } } },
            { id: 'tomatoTycoon', name: 'Tomato Tycoon', desc: 'Harvest 10 tomatoes!', unlock: 'character', character: { emoji: 'üë®‚Äçüåæ', name: 'Farmer Bob', text: 'Tomatoes are tasty!' }, reward: { money: 30, seeds: { tomato: 3 } } },
            { id: 'hatCollector', name: 'Hat Collector', desc: 'Fulfill 3 orders!', unlock: 'cosmetic', hat: 'üé©', reward: { money: 50 } },
            { id: 'bgMaster', name: 'Background Master', desc: 'Fulfill 5 orders!', unlock: 'cosmetic', background: 'linear-gradient(135deg,#f9d423,#ff4e50)', reward: { money: 100 } }
        ];
        let cropHarvestCount = { wheat: 0, carrot: 0, tomato: 0, corn: 0, potato: 0, lettuce: 0 };
        let ordersFulfilled = 0;

        // Recipes system
        const recipes = [
            { name: 'Salad', ingredients: { lettuce: 2, tomato: 1 }, emoji: 'ü•ó', energy: 30, price: 40 },
            { name: 'Veggie Stew', ingredients: { potato: 1, carrot: 1, corn: 1 }, emoji: 'üç≤', energy: 40, price: 50 },
            { name: 'Bread', ingredients: { wheat: 3 }, emoji: 'üçû', energy: 20, price: 30 },
            { name: 'Fries', ingredients: { potato: 2 }, emoji: 'üçü', energy: 25, price: 35 }
        ];
        let cooked = {};
        recipes.forEach(r => cooked[r.name] = 0);

        // Inventory object to track harvested crops
        let inventory = { wheat: 0, carrot: 0, tomato: 0, corn: 0, potato: 0, lettuce: 0 };
        // Inventory for cooked foods
        let cookedInventory = { Salad: 0, 'Veggie Stew': 0, Bread: 0, Fries: 0 };

        function renderFieldControls() {
            let html = '<b>Fields:</b> ';
            for (let i = 0; i < numFields; i++) {
                html += `<button onclick=\"switchField(${i})\" ${i === currentField ? 'disabled' : ''}>Field ${i+1}</button>`;
            }
            document.getElementById('fieldControls').innerHTML = html;
        }
        function switchField(idx) {
            currentField = idx;
            renderAll();
        }
        function renderField() {
            const oldMenu = document.getElementById('seedMenu');
            if (oldMenu) oldMenu.remove();
            const fieldDiv = document.getElementById('field');
            fieldDiv.innerHTML = '';
            // Render as a 5x5 grid
            const cols = 5;
            for (let row = 0; row < 5; row++) {
                const rowDiv = document.createElement('div');
                rowDiv.style.display = 'flex';
                rowDiv.style.justifyContent = 'center';
                for (let col = 0; col < cols; col++) {
                    const i = row * cols + col;
                    let plot = fields[currentField][i];
                    let plotClass = 'plot empty';
                    let emoji = 'üü©';
                    if (plot) {
                        plotClass = `plot ${plot.type}-${plot.stage}`;
                        if (plot.stage === 'planted') emoji = crops[plot.type].seedEmoji;
                        else if (plot.stage === 'grown') emoji = crops[plot.type].emoji;
                    }
                    // Show player emoji centered in the plot if player is here
                    let content = (i === player.pos)
                        ? `<span style='font-size:32px;display:flex;align-items:center;justify-content:center;width:100%;height:100%;'>${player.emoji}</span>`
                        : emoji;
                    const plotDiv = document.createElement('div');
                    plotDiv.className = plotClass;
                    plotDiv.style.position = 'relative';
                    plotDiv.innerHTML = content;
                    plotDiv.onclick = function() { plantSeedPrompt(i); };
                    rowDiv.appendChild(plotDiv);
                }
                fieldDiv.appendChild(rowDiv);
            }
        }
        function renderStats() {
            document.getElementById('stats').innerHTML = `Money: $${money} | ` + Object.keys(seeds).map(type=>`${crops[type].name} Seeds: ${seeds[type]}`).join(' | ') + ` | Total Harvest: ${harvest}`;
        }
        function renderEnergyBar() {
            const percent = Math.max(0, Math.min(100, player.energy / player.maxEnergy * 100));
            document.getElementById('energyBar').innerHTML = `<div class='energy-bar'><div class='energy-fill' style='width:${percent}%;'></div></div>Energy: ${player.energy}/${player.maxEnergy}`;
        }
        // Remove duplicate keydown listeners and only use one
        // Remove the .player div rendering, only show player in the field
        // Update renderField to show player emoji in the correct plot
        function renderField() {
            const oldMenu = document.getElementById('seedMenu');
            if (oldMenu) oldMenu.remove();
            const fieldDiv = document.getElementById('field');
            fieldDiv.innerHTML = '';
            // Render as a 5x5 grid
            const cols = 5;
            for (let row = 0; row < 5; row++) {
                const rowDiv = document.createElement('div');
                rowDiv.style.display = 'flex';
                rowDiv.style.justifyContent = 'center';
                for (let col = 0; col < cols; col++) {
                    const i = row * cols + col;
                    let plot = fields[currentField][i];
                    let plotClass = 'plot empty';
                    let emoji = 'üü©';
                    if (plot) {
                        plotClass = `plot ${plot.type}-${plot.stage}`;
                        if (plot.stage === 'planted') emoji = crops[plot.type].seedEmoji;
                        else if (plot.stage === 'grown') emoji = crops[plot.type].emoji;
                    }
                    // Show player emoji centered in the plot if player is here
                    let content = (i === player.pos)
                        ? `<span style='font-size:32px;display:flex;align-items:center;justify-content:center;width:100%;height:100%;'>${player.emoji}</span>`
                        : emoji;
                    const plotDiv = document.createElement('div');
                    plotDiv.className = plotClass;
                    plotDiv.style.position = 'relative';
                    plotDiv.innerHTML = content;
                    plotDiv.onclick = function() { plantSeedPrompt(i); };
                    rowDiv.appendChild(plotDiv);
                }
                fieldDiv.appendChild(rowDiv);
            }
        }
        function renderShop() {
            let html = '<h3>Seed Shop</h3>';
            Object.keys(crops).forEach(type => {
                html += `<div>${crops[type].name} Seed (${crops[type].seedEmoji}): $${crops[type].price} <button onclick=\"buySeed('${type}')\">Buy</button></div>`;
            });
            document.getElementById('shop').innerHTML = html;
        }
        function renderAchievements() {
            let html = '<h3>Achievements</h3>';
            achievementList.forEach(a => {
                const unlocked = achievements.includes(a.id);
                let rewardText = '';
                if (a.reward) {
                    let rewards = [];
                    if (a.reward.money) rewards.push(`+$${a.reward.money}`);
                    if (a.reward.seeds) {
                        Object.entries(a.reward.seeds).forEach(([type, amt]) => {
                            rewards.push(`+${amt} ${crops[type].name} seeds`);
                        });
                    }
                    rewardText = rewards.length ? ` <span style="color:#43a047;font-size:14px;">[${rewards.join(', ')}]</span>` : '';
                }
                html += `<div>${unlocked ? '‚úÖ' : '‚¨ú'} <b>${a.name}</b>: ${a.desc}${rewardText}</div>`;
            });
            document.getElementById('achievements').innerHTML = html;
        }
        function renderPets() {
            let html = '<h3>Pets</h3>';
            pets.forEach(pet => {
                html += `<span class="pet">${pet}</span>`;
            });
            document.getElementById('pets').innerHTML = html;
        }
        function renderCharacters() {
            let html = '<h3>Characters</h3>';
            characters.forEach(char => {
                html += `<span class="character" onclick=\"talkToCharacter('${char.name}')\">${char.emoji} ${char.name}</span>`;
            });
            document.getElementById('characters').innerHTML = html;
        }
        function renderCosmetics() {
            let html = '<h3>Cosmetics</h3>';
            html += '<div>Hats: ';
            cosmetics.hats.forEach(hat => {
                html += `<span style=\"font-size:28px;cursor:pointer;${cosmetics.equippedHat===hat?'border:2px solid #4caf50;':''}\" onclick=\"equipHat('${hat}')\">${hat}</span> `;
            });
            html += '</div><div>Backgrounds: ';
            cosmetics.backgrounds.forEach(bg => {
                html += `<span style=\"font-size:20px;cursor:pointer;${cosmetics.equippedBg===bg?'border:2px solid #4caf50;':''}\" onclick=\"equipBg('${bg}')\">${bg}</span> `;
            });
            html += '</div>';
            document.getElementById('cosmetics').innerHTML = html;
            if (cosmetics.equippedBg) document.body.style.background = cosmetics.equippedBg;
        }
        function renderOrders() {
            let html = '<h3>Orders</h3>';
            if (orders.length === 0) html += '<div>No orders! <button onclick="generateOrder();renderOrders();">New Order</button></div>';
            orders.forEach(order => {
                html += `<div class="order">Order #${order.id}: ${order.amount} ${crops[order.type].emoji} ${crops[order.type].name} <button onclick=\"fulfillOrder(${order.id})\">Fulfill</button> (Reward: $${order.reward})</div>`;
            });
            document.getElementById('orders').innerHTML = html;
        }
        function renderRecipes() {
            let html = '<h3>Recipes</h3>';
            recipes.forEach(r => {
                let canCook = Object.entries(r.ingredients).every(([type, amt]) => inventory[type] >= amt);
                html += `<div>${r.emoji} <b>${r.name}</b> (${Object.entries(r.ingredients).map(([k,v])=>v+' '+crops[k].emoji).join(', ')}) <button class="${canCook ? 'cook-available' : ''}" onclick="cookRecipe('${r.name}')" ${canCook?'':'disabled'}>Cook</button> (Energy: +${r.energy}, Sell: $${r.price}) Cooked: ${cooked[r.name]}</div>`;
            });
            document.getElementById('recipes').innerHTML = html;
        }
        // Add a modal for cutscenes
        const cutsceneModal = document.createElement('div');
        cutsceneModal.id = 'cutsceneModal';
        cutsceneModal.style.display = 'none';
        cutsceneModal.style.position = 'fixed';
        cutsceneModal.style.top = '0';
        cutsceneModal.style.left = '0';
        cutsceneModal.style.width = '100vw';
        cutsceneModal.style.height = '100vh';
        cutsceneModal.style.background = 'rgba(0,0,0,0.7)';
        cutsceneModal.style.zIndex = '10002';
        cutsceneModal.style.alignItems = 'center';
        cutsceneModal.style.justifyContent = 'center';
        cutsceneModal.innerHTML = `<div id="cutsceneContent" style="background:#fff;padding:32px 24px;border-radius:12px;max-width:400px;margin:auto;text-align:center;position:relative;"></div>`;
        document.body.appendChild(cutsceneModal);

        function showCutscene(html, onClose) {
            document.getElementById('cutsceneContent').innerHTML = html + '<br><br><button onclick="closeCutscene()">Continue</button>';
            cutsceneModal.style.display = 'flex';
            cutsceneModal.onCloseCallback = onClose;
        }
        function closeCutscene() {
            cutsceneModal.style.display = 'none';
            if (typeof cutsceneModal.onCloseCallback === 'function') cutsceneModal.onCloseCallback();
        }

        // Add a new recipe to the recipes list if not already present
        function addRecipe(recipeObj) {
            if (!recipes.some(r => r.name === recipeObj.name)) {
                recipes.push(recipeObj);
                cooked[recipeObj.name] = 0;
                cookedInventory[recipeObj.name] = 0;
            }
        }

        // Check and unlock achievements
        function checkAchievements() {
            achievementList.forEach(a => {
                if (!achievements.includes(a.id)) {
                    let unlocked = false;
                    if (a.id === 'firstHarvest' && harvest >= 1) unlocked = true;
                    if (a.id === 'wheatMaster' && cropHarvestCount.wheat >= 10) unlocked = true;
                    if (a.id === 'carrotKing' && cropHarvestCount.carrot >= 10) unlocked = true;
                    if (a.id === 'tomatoTycoon' && cropHarvestCount.tomato >= 10) unlocked = true;
                    if (a.id === 'hatCollector' && ordersFulfilled >= 3) unlocked = true;
                    if (a.id === 'bgMaster' && ordersFulfilled >= 5) unlocked = true;
                    if (unlocked) {
                        achievements.push(a.id);
                        if (a.unlock === 'pet') pets.push(a.pet);
                        if (a.unlock === 'character') {
                            characters.push(a.character);
                            // Show cutscene for new character
                            if (a.character.name === 'Farmer Jill') {
                                showCutscene(`<span style='font-size:32px;'>${a.character.emoji}</span><br><b>${a.character.name}</b><br><br>Welcome to the farm! I'm here to help you become a great farmer.<br><br>Here, take my special recipe for <b>Berry Pie</b>!`, function() {
                                    addRecipe({ name: 'Berry Pie', ingredients: { wheat: 2, tomato: 1 }, emoji: 'ü•ß', energy: 35, price: 45 });
                                    showNotification('New recipe unlocked: Berry Pie!');
                                    renderRecipes();
                                });
                            } else if (a.character.name === 'Farmer Bob') {
                                showCutscene(`<span style='font-size:32px;'>${a.character.emoji}</span><br><b>${a.character.name}</b><br><br>Tomatoes are tasty! Keep growing and I'll share more tips soon.`);
                            }
                        }
                        if (a.id === 'firstHarvest') {
                            // Unlock Farmer Jill after first harvest (if not already in characters)
                            if (!characters.some(c => c.name === 'Farmer Jill')) {
                                characters.push({ emoji: 'üë©\u200düåæ', name: 'Farmer Jill', text: 'Welcome to the farm! I\'m here to help.' });
                                showCutscene(`<span style='font-size:32px;'>üë©‚Äçüåæ</span><br><b>Farmer Jill</b><br><br>Welcome to the farm! I'm here to help you become a great farmer.<br><br>Here, take my special recipe for <b>Berry Pie</b>!`, function() {
                                    addRecipe({ name: 'Berry Pie', ingredients: { wheat: 2, tomato: 1 }, emoji: 'ü•ß', energy: 35, price: 45 });
                                    showNotification('New recipe unlocked: Berry Pie!');
                                    renderRecipes();
                                });
                            }
                        }
                        if (a.unlock === 'cosmetic' && a.hat) cosmetics.hats.push(a.hat);
                        if (a.unlock === 'cosmetic' && a.background) cosmetics.backgrounds.push(a.background);
                        // Grant rewards and show a single notification
                        let rewardMsg = `Achievement unlocked: ${a.name}!`;
                        if (a.reward) {
                            let rewards = [];
                            if (a.reward.money) {
                                money += a.reward.money;
                                rewards.push(`+$${a.reward.money}`);
                            }
                            if (a.reward.seeds) {
                                Object.entries(a.reward.seeds).forEach(([type, amt]) => {
                                    seeds[type] = (seeds[type] || 0) + amt;
                                    rewards.push(`+${amt} ${crops[type].name} seeds`);
                                });
                            }
                            if (rewards.length) rewardMsg += ' ' + rewards.join(', ');
                        }
                        showNotification(rewardMsg);
                    }
                }
            });
            renderAchievements();
            renderPets();
            renderCharacters();
            renderCosmetics();
        }

        // Planting with energy and player position (now with selection menu)
        function plantSeedPrompt(index) {
            if (fields[currentField][index] || player.energy < 5 || player.pos !== index) return;
            let options = Object.keys(crops).filter(type => seeds[type] > 0);
            if (options.length === 0) { alert('No seeds! Buy some in the shop.'); return; }
            // Show a menu below the plot for seed selection
            showSeedMenu(index, options);
        }
        function showSeedMenu(index, options) {
            // Remove any existing menu
            let oldMenu = document.getElementById('seedMenu');
            if (oldMenu) oldMenu.remove();
            // Find the plot div
            const fieldDiv = document.getElementById('field');
            const plotDivs = fieldDiv.querySelectorAll('.plot');
            const plotDiv = plotDivs[index];
            // Create menu
            const menu = document.createElement('div');
            menu.id = 'seedMenu';
            menu.style.position = 'absolute';
            menu.style.background = '#fff';
            menu.style.border = '1px solid #aaa';
            menu.style.borderRadius = '6px';
            menu.style.padding = '6px';
            menu.style.zIndex = 10;
            menu.style.top = (plotDiv.offsetTop + 70) + 'px';
            menu.style.left = (plotDiv.offsetLeft - 10) + 'px';
            options.forEach(type => {
                const btn = document.createElement('button');
                btn.textContent = crops[type].seedEmoji + ' ' + crops[type].name;
                btn.onclick = function() {
                    seeds[type]--;
                    fields[currentField][index] = { type: type, stage: 'planted', watered: false };
                    growthTimers[currentField][index] = 0;
                    player.energy -= 5;
                    menu.remove();
                    renderField();
                    renderStats();
                    renderEnergyBar();
                };
                menu.appendChild(btn);
            });
            // Add cancel button
            const cancel = document.createElement('button');
            cancel.textContent = 'Cancel';
            cancel.onclick = function() { menu.remove(); };
            menu.appendChild(cancel);
            // Add to container
            document.querySelector('.container').appendChild(menu);
        }
        function renderAll() {
            renderStats();
            renderEnergyBar();
            renderFieldControls();
            renderField();
            renderShop();
            renderOrders();
            renderRecipes();
            renderAchievements();
            renderPets();
            renderCharacters();
            renderCosmetics();
            renderInventory();
            renderSellBin();
            renderAvatarAndPetControls();
        }
        // Keyboard controls for player movement (WASD only)
        document.addEventListener('keydown', function(e) {
            if (e.key === 'a' || e.key === 'A') movePlayer('left');
            if (e.key === 'd' || e.key === 'D') movePlayer('right');
            if (e.key === 'w' || e.key === 'W') movePlayer('up');
            if (e.key === 's' || e.key === 'S') movePlayer('down');
        });
        // Progress bar animation
        function animateProgressBar(duration = 3000) {
            const bar = document.getElementById('progressBar');
            bar.style.width = '0%';
            let start = null;
            function step(timestamp) {
                if (!start) start = timestamp;
                let progress = Math.min((timestamp - start) / duration, 1);
                bar.style.width = (progress * 100) + '%';
                if (progress < 1) {
                    requestAnimationFrame(step);
                }
            }
            requestAnimationFrame(step);
        }
        // Simulate crop growth every 5 seconds
        if (typeof timerGrow !== 'undefined') clearInterval(timerGrow);
        // Shorten timer to 2 seconds for faster gameplay
        timerGrow = setInterval(growCrops, 2000);
        window.addEventListener('DOMContentLoaded', function() {
            animateProgressBar();
            renderAll();
        });
        // Initial render
        renderAll();
        function showNotification(msg) {
            const n = document.getElementById('notification');
            n.textContent = msg;
            n.style.display = 'block';
            n.style.opacity = '1';
            setTimeout(() => { n.style.opacity = '0'; }, 1200);
            setTimeout(() => { n.style.display = 'none'; }, 1600);
        }
        function buySeed(type) {
            if (money >= crops[type].price) {
                money -= crops[type].price;
                seeds[type]++;
                showNotification(`Purchased 1 ${crops[type].name} seed!`);
                renderStats();
                renderShop();
            } else {
                showNotification('Not enough money!');
            }
        }
        // Water animation for each plot
        function animateWaterDropletOnPlot(plotIndex) {
            const fieldDiv = document.getElementById('field');
            const plotDivs = fieldDiv.querySelectorAll('.plot');
            const plotDiv = plotDivs[plotIndex];
            if (!plotDiv) return;
            const droplet = document.createElement('span');
            droplet.textContent = 'üíß';
            droplet.style.position = 'absolute';
            droplet.style.left = '50%';
            droplet.style.top = '10%';
            droplet.style.transform = 'translate(-50%, 0)';
            droplet.style.fontSize = '28px';
            droplet.style.opacity = '1';
            droplet.style.transition = 'top 0.7s cubic-bezier(.4,2,.6,1), opacity 0.7s';
            plotDiv.appendChild(droplet);
            setTimeout(() => {
                droplet.style.top = '-30px';
                droplet.style.opacity = '0';
            }, 30);
            setTimeout(() => {
                droplet.remove();
            }, 800);
        }

        // Water all crops in the current field
        function waterCrops() {
            let watered = false;
            for (let i = 0; i < fieldSize; i++) {
                let plot = fields[currentField][i];
                if (plot && plot.stage === 'planted' && !plot.watered) {
                    plot.watered = true;
                    watered = true;
                    animateWaterDropletOnPlot(i);
                }
            }
            renderField();
            if (watered) {
                showNotification('Crops watered!');
            } else {
                showNotification('No crops to water!');
            }
        }

        // Grow crops over time (simulate growth for demo)
        function growCrops() {
            let anyGrown = false;
            for (let i = 0; i < fieldSize; i++) {
                let plot = fields[currentField][i];
                if (plot && plot.stage === 'planted' && plot.watered) {
                    growthTimers[currentField][i]++;
                    if (growthTimers[currentField][i] >= crops[plot.type].growTime) {
                        plot.stage = 'grown';
                        plot.watered = false;
                        animateSparkleOnPlot(i);
                        showNotification(`${crops[plot.type].name} is fully grown!`);
                        anyGrown = true;
                    }
                }
            }
            renderField();
            return anyGrown;
        }

        // Harvest all grown crops in the current field
        function harvestCrops() {
            let harvested = false;
            for (let i = 0; i < fieldSize; i++) {
                let plot = fields[currentField][i];
                if (plot && plot.stage === 'grown') {
                    cropHarvestCount[plot.type] = (cropHarvestCount[plot.type] || 0) + 1;
                    inventory[plot.type] = (inventory[plot.type] || 0) + 1;
                    harvest++;
                    fields[currentField][i] = null;
                    harvested = true;
                }
            }
            renderField();
            renderStats();
            renderInventory();
            renderSellBin();
            renderRecipes(); // <-- ensure recipes update after harvest
            if (harvested) {
                showNotification('Crops harvested!');
            } else {
                showNotification('No crops to harvest!');
            }
            checkAchievements(); // <-- always check achievements after harvest
        }

        // Update fulfillOrder to check achievements (if not already present)
        function fulfillOrder(id) {
            const idx = orders.findIndex(o => o.id === id);
            if (idx === -1) return;
            const order = orders[idx];
            if (inventory[order.type] >= order.amount) {
                inventory[order.type] -= order.amount;
                money += order.reward;
                ordersFulfilled++;
                orders.splice(idx, 1);
                showNotification('Order fulfilled!');
                renderStats();
                renderOrders();
                renderInventory();
                renderSellBin();
                checkAchievements();
                // Generate a new order if none left
                ensureOrders();
            } else {
                showNotification('Not enough crops to fulfill order!');
            }
        }
        // Planting with energy and player position (now with selection menu)
        function plantSeedPrompt(index) {
            if (fields[currentField][index] || player.energy < 5 || player.pos !== index) return;
            let options = Object.keys(crops).filter(type => seeds[type] > 0);
            if (options.length === 0) { alert('No seeds! Buy some in the shop.'); return; }
            // Show a menu below the plot for seed selection
            showSeedMenu(index, options);
        }
        function showSeedMenu(index, options) {
            // Remove any existing menu
            let oldMenu = document.getElementById('seedMenu');
            if (oldMenu) oldMenu.remove();
            // Find the plot div
            const fieldDiv = document.getElementById('field');
            const plotDivs = fieldDiv.querySelectorAll('.plot');
            const plotDiv = plotDivs[index];
            // Create menu
            const menu = document.createElement('div');
            menu.id = 'seedMenu';
            menu.style.position = 'absolute';
            menu.style.background = '#fff';
            menu.style.border = '1px solid #aaa';
            menu.style.borderRadius = '6px';
            menu.style.padding = '6px';
            menu.style.zIndex = 10;
            menu.style.top = (plotDiv.offsetTop + 70) + 'px';
            menu.style.left = (plotDiv.offsetLeft - 10) + 'px';
            options.forEach(type => {
                const btn = document.createElement('button');
                btn.textContent = crops[type].seedEmoji + ' ' + crops[type].name;
                btn.onclick = function() {
                    seeds[type]--;
                    fields[currentField][index] = { type: type, stage: 'planted', watered: false };
                    growthTimers[currentField][index] = 0;
                    player.energy -= 5;
                    menu.remove();
                    renderField();
                    renderStats();
                    renderEnergyBar();
                };
                menu.appendChild(btn);
            });
            // Add cancel button
            const cancel = document.createElement('button');
            cancel.textContent = 'Cancel';
            cancel.onclick = function() { menu.remove(); };
            menu.appendChild(cancel);
            // Add to container
            document.querySelector('.container').appendChild(menu);
        }
        function renderAll() {
            renderStats();
            renderEnergyBar();
            renderFieldControls();
            renderField();
            renderShop();
            renderOrders();
            renderRecipes();
            renderAchievements();
            renderPets();
            renderCharacters();
            renderCosmetics();
            renderInventory();
            renderSellBin();
            renderAvatarAndPetControls();
        }
        // Keyboard controls for player movement (WASD only)
        document.addEventListener('keydown', function(e) {
            if (e.key === 'a' || e.key === 'A') movePlayer('left');
            if (e.key === 'd' || e.key === 'D') movePlayer('right');
            if (e.key === 'w' || e.key === 'W') movePlayer('up');
            if (e.key === 's' || e.key === 'S') movePlayer('down');
        });
        // Progress bar animation
        function animateProgressBar(duration = 3000) {
            const bar = document.getElementById('progressBar');
            bar.style.width = '0%';
            let start = null;
            function step(timestamp) {
                if (!start) start = timestamp;
                let progress = Math.min((timestamp - start) / duration, 1);
                bar.style.width = (progress * 100) + '%';
                if (progress < 1) {
                    requestAnimationFrame(step);
                }
            }
            requestAnimationFrame(step);
        }
        // Simulate crop growth every 5 seconds
        if (typeof timerGrow !== 'undefined') clearInterval(timerGrow);
        // Shorten timer to 2 seconds for faster gameplay
        timerGrow = setInterval(growCrops, 2000);
        window.addEventListener('DOMContentLoaded', function() {
            animateProgressBar();
            renderAll();
        });
        // Initial render
        renderAll();
        function showNotification(msg) {
            const n = document.getElementById('notification');
            n.textContent = msg;
            n.style.display = 'block';
            n.style.opacity = '1';
            setTimeout(() => { n.style.opacity = '0'; }, 1200);
            setTimeout(() => { n.style.display = 'none'; }, 1600);
        }
        function buySeed(type) {
            if (money >= crops[type].price) {
                money -= crops[type].price;
                seeds[type]++;
                showNotification(`Purchased 1 ${crops[type].name} seed!`);
                renderStats();
                renderShop();
            } else {
                showNotification('Not enough money!');
            }
        }
        // Water animation for each plot
        function animateWaterDropletOnPlot(plotIndex) {
            const fieldDiv = document.getElementById('field');
            const plotDivs = fieldDiv.querySelectorAll('.plot');
            const plotDiv = plotDivs[plotIndex];
            if (!plotDiv) return;
            const droplet = document.createElement('span');
            droplet.textContent = 'üíß';
            droplet.style.position = 'absolute';
            droplet.style.left = '50%';
            droplet.style.top = '10%';
            droplet.style.transform = 'translate(-50%, 0)';
            droplet.style.fontSize = '28px';
            droplet.style.opacity = '1';
            droplet.style.transition = 'top 0.7s cubic-bezier(.4,2,.6,1), opacity 0.7s';
            plotDiv.appendChild(droplet);
            setTimeout(() => {
                droplet.style.top = '-30px';
                droplet.style.opacity = '0';
            }, 30);
            setTimeout(() => {
                droplet.remove();
            }, 800);
        }

        // Water all crops in the current field
        function waterCrops() {
            let watered = false;
            for (let i = 0; i < fieldSize; i++) {
                let plot = fields[currentField][i];
                if (plot && plot.stage === 'planted' && !plot.watered) {
                    plot.watered = true;
                    watered = true;
                    animateWaterDropletOnPlot(i);
                }
            }
            renderField();
            if (watered) {
                showNotification('Crops watered!');
            } else {
                showNotification('No crops to water!');
            }
        }

        // Grow crops over time (simulate growth for demo)
        function growCrops() {
            let anyGrown = false;
            for (let i = 0; i < fieldSize; i++) {
                let plot = fields[currentField][i];
                if (plot && plot.stage === 'planted' && plot.watered) {
                    growthTimers[currentField][i]++;
                    if (growthTimers[currentField][i] >= crops[plot.type].growTime) {
                        plot.stage = 'grown';
                        plot.watered = false;
                        animateSparkleOnPlot(i);
                        showNotification(`${crops[plot.type].name} is fully grown!`);
                        anyGrown = true;
                    }
                }
            }
            renderField();
            return anyGrown;
        }

        // Harvest all grown crops in the current field
        function harvestCrops() {
            let harvested = false;
            for (let i = 0; i < fieldSize; i++) {
                let plot = fields[currentField][i];
                if (plot && plot.stage === 'grown') {
                    cropHarvestCount[plot.type] = (cropHarvestCount[plot.type] || 0) + 1;
                    inventory[plot.type] = (inventory[plot.type] || 0) + 1;
                    harvest++;
                    fields[currentField][i] = null;
                    harvested = true;
                }
            }
            renderField();
            renderStats();
            renderInventory();
            renderSellBin();
            renderRecipes(); // <-- ensure recipes update after harvest
            if (harvested) {
                showNotification('Crops harvested!');
            } else {
                showNotification('No crops to harvest!');
            }
            checkAchievements(); // <-- always check achievements after harvest
        }

        // Cook a recipe if enough ingredients in inventory
        function cookRecipe(recipeName) {
            const recipe = recipes.find(r => r.name === recipeName);
            if (!recipe) return;
            // Check if enough ingredients in inventory
            let canCook = Object.entries(recipe.ingredients).every(([type, amt]) => inventory[type] >= amt);
            if (!canCook) {
                showNotification('Not enough ingredients!');
                return;
            }
            // Deduct ingredients
            Object.entries(recipe.ingredients).forEach(([type, amt]) => {
                inventory[type] -= amt;
            });
            cooked[recipe.name] = (cooked[recipe.name] || 0) + 1;
            cookedInventory[recipe.name] = (cookedInventory[recipe.name] || 0) + 1;
            showNotification(`Cooked ${recipe.emoji} ${recipe.name}! (Added to inventory)`);
            renderStats();
            renderEnergyBar();
            renderInventory();
            renderSellBin();
            renderRecipes();
        }
        function renderAvatarAndPetControls() {
            let html = '<h3>Avatar & Pet</h3>';
            // Avatar selection
            html += '<div><b>Avatar:</b> ';
            playerEmojis.forEach(e => {
                html += `<span style="font-size:28px;cursor:pointer;${player.emoji===e?'border:2px solid #2196f3;':''}" onclick="changeAvatar('${e}')">${e}</span> `;
            });
            html += '</div>';
            // Pet equipping
            html += '<div style="margin-top:10px;"><b>Pet:</b> ';
            if (pets.length === 0) {
                html += '<span style="color:#888;">(No pets unlocked)</span>';
            } else {
                pets.forEach(pet => {
                    html += `<span style="font-size:28px;cursor:pointer;${player.equippedPet===pet?'border:2px solid #43a047;':''}" onclick="equipPet('${pet}')">${pet}</span> `;
                });
                html += `<span style="font-size:16px;margin-left:8px;cursor:pointer;color:#888;" onclick="equipPet(null)">(Unequip)</span>`;
            }
            html += '</div>';
            document.getElementById('avatarPetControls').innerHTML = html;
        }

        function changeAvatar(emoji) {
            player.emoji = emoji;
            renderAll();
        }
        function equipPet(pet) {
            player.equippedPet = pet;
            renderAll();
        }

        // Show intro modal on first visit
        function showIntro() {
            const visited = localStorage.getItem('visited');
            if (!visited) {
                document.getElementById('introModal').style.display = 'flex';
                localStorage.setItem('visited', 'true');
            } else {
                // If already visited, just render everything
                renderAll();
            }
        }
        function closeIntro() {
            document.getElementById('introModal').style.display = 'none';
            renderAll();
        }
        // Show the intro modal on page load
        window.addEventListener('load', showIntro);
    </script>
</body>
</html>
