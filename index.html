<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farming Simulator</title>
    <style>
        body { font-family: Arial, sans-serif; background: #e6ffe6; margin: 0; padding: 0; }
        .container { max-width: 900px; margin: 40px auto; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px #aaa; padding: 24px; }
        h1 { text-align: center; }
        .field { display: grid; grid-template-columns: repeat(5, 60px); gap: 10px; justify-content: center; margin: 20px 0; }
        .plot { width: 60px; height: 60px; background: #b3e6b3; border: 2px solid #6c9e6c; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 24px; transition: background 0.2s; }
        .plot.empty { background: #b3e6b3; }
        .plot.wheat-planted { background: #ffe066; }
        .plot.wheat-grown { background: #ffb347; }
        .plot.carrot-planted { background: #f9c784; }
        .plot.carrot-grown { background: #ff914d; }
        .plot.tomato-planted { background: #ffb3b3; }
        .plot.tomato-grown { background: #ff4d4d; }
        .controls, .shop, .achievements, .pets, .characters { text-align: center; margin-top: 20px; }
        button { padding: 8px 16px; font-size: 16px; border-radius: 5px; border: none; background: #4caf50; color: #fff; cursor: pointer; margin: 0 5px; }
        button:disabled { background: #aaa; }
        button.cook-available {
            background: #43d15c !important;
            border: 2px solid #2e8b3a !important;
            color: #fff;
        }
        .stats { text-align: center; margin-top: 20px; }
        .shop { background: #e0ffe0; border-radius: 8px; padding: 10px; margin: 20px 0; }
        .achievements { background: #fffbe0; border-radius: 8px; padding: 10px; margin: 20px 0; }
        .pets, .characters { background: #e0f7ff; border-radius: 8px; padding: 10px; margin: 20px 0; }
        .pet, .character { display: inline-block; margin: 0 10px; font-size: 32px; }
        .cosmetics { text-align: center; margin-top: 20px; }
        .field-controls { text-align: center; margin: 20px 0; }
        .order { background: #fff3cd; border: 1px solid #ffeeba; border-radius: 8px; padding: 10px; margin: 10px 0; }
        .energy-bar { margin: 10px auto; width: 300px; height: 24px; background: #eee; border-radius: 12px; overflow: hidden; border: 1px solid #aaa; }
        .energy-fill { height: 100%; background: linear-gradient(90deg,#4caf50,#a8e063); transition: width 0.3s; }
        .player { text-align: center; font-size: 40px; margin: 10px 0; }
        .recipes { background: #fff0e0; border-radius: 8px; padding: 10px; margin: 20px 0; }
        .intro-modal { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.6); z-index: 9999; align-items: center; justify-content: center; pointer-events: all; }
        .intro-modal > div { background: #fff; padding: 32px 24px; border-radius: 12px; max-width: 400px; margin: auto; text-align: center; z-index: 10000; pointer-events: all; }
        #emojiPicker button { font-size: 28px; margin: 4px; cursor: pointer; z-index: 10001; pointer-events: all; }
        #notification { display:none; position:fixed; top:30px; left:50%; transform:translateX(-50%); background:#4caf50; color:#fff; padding:12px 32px; border-radius:8px; box-shadow:0 2px 8px #aaa; font-size:18px; z-index:10001; pointer-events:none; transition:opacity 0.4s; }
        .inventory { background: #f0f8ff; border-radius: 8px; padding: 10px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Farming Simulator</h1>
        <div id="notification"></div>
        <div id="fieldControls" class="field-controls"></div>
        <div id="field" class="field"></div>
        <div style="text-align:center;margin:10px 0;">
            <button onclick="restPlayer()" id="restBtn">Rest</button>
        </div>
        <div id="stats" class="stats"></div>
        <div id="energyBar" class="energy-bar"></div>
        <div class="controls">
            <button onclick="waterCrops()">Water Crops</button>
            <button onclick="harvestCrops()">Harvest Crops</button>
            <button onclick="showInventory()">Show Inventory</button>
            <button onclick="showSellBin()">Show Sell Bin</button>
        </div>
        <div id="shop" class="shop"></div>
        <div id="orders" class="orders"></div>
        <div id="recipes" class="recipes"></div>
        <div id="achievements" class="achievements"></div>
        <div id="pets" class="pets"></div>
        <div id="characters" class="characters"></div>
        <div id="cosmetics" class="cosmetics"></div>
        <div id="avatarPetControls"></div>
        <div id="inventory" class="inventory"></div>
        <div id="progressBarContainer" style="margin:20px 0;">
            <div id="progressBar" style="width:100%;height:8px;background:#4caf50;border-radius:4px;"></div>
        </div>
        <div class="controls">
            <button onclick="switchField(0)">Field 1</button>
            <button onclick="switchField(1)">Field 2</button>
            <button onclick="switchField(2)">Field 3</button>
        </div>
        <div id="seedMenu" style="display:none;position:absolute;background:#fff;border:1px solid #aaa;border-radius:6px;padding:6px;z-index:10;"></div>
    </div>
    <!-- Intro Modal for Farmer Jill -->
    <div id="introModal" class="intro-modal" style="display:flex;">
      <div>
        <span style="font-size:40px;">üë©‚Äçüåæ</span>
        <h2>Hi, I'm Farmer Jill!</h2>
        <p>Welcome to the farm! Here‚Äôs how to play:</p>
        <ul style="text-align:left;max-width:320px;margin:0 auto 12px auto;font-size:16px;">
          <li>Move your avatar around the field.</li>
          <li>Plant seeds, water crops, and harvest them for money.</li>
          <li>Buy more seeds in the shop and complete orders for rewards.</li>
          <li>Unlock pets, recipes, and more as you play!</li>
        </ul>
        <p><b>Choose your avatar:</b></p>
        <div id="avatarChoices" style="margin-bottom:16px;"></div>
        <button id="startGameBtn" disabled>Start Farming!</button>
      </div>
    </div>
    <script>
        // --- CUTSCENE MODAL CREATION (must be at the top) ---
        const cutsceneModal = document.createElement('div');
        cutsceneModal.id = 'cutsceneModal';
        cutsceneModal.style.display = 'none';
        cutsceneModal.style.position = 'fixed';
        cutsceneModal.style.top = '0';
        cutsceneModal.style.left = '0';
        cutsceneModal.style.width = '100vw';
        cutsceneModal.style.height = '100vh';
        cutsceneModal.style.background = 'rgba(0,0,0,0.7)';
        cutsceneModal.style.zIndex = '10002';
        cutsceneModal.style.alignItems = 'center';
        cutsceneModal.style.justifyContent = 'center';
        cutsceneModal.innerHTML = `<div id="cutsceneContent" style="background:#fff;padding:32px 24px;border-radius:12px;max-width:400px;margin:auto;text-align:center;position:relative;"></div>`;
        document.body.appendChild(cutsceneModal);

        // Emoji options for player
        const playerEmojis = ['üßë‚Äçüåæ','üë©‚Äçüåæ','üë®‚Äçüåæ','ü¶∏','üßô','üßë‚Äçüç≥','üßë‚ÄçüöÄ','üßë‚Äçüé®','üßë‚Äçüî¨','üßë‚Äçüíª','ü¶Ñ','üê±','üê∂','üê∞','üêª','üê∏'];
        const playerEmojis = ['üßë‚Äçüåæ','üë©‚Äçüåæ','üë®‚Äçüåæ','ü¶∏','üßô','üßë‚Äçüç≥','üßë‚ÄçüöÄ','üßë‚Äçüé®','üßë‚Äçüî¨','üßë‚Äçüíª','ü¶Ñ','üê±','üê∂','üê∞','üêª','üê∏'];
        // Crop definitions
        const crops = {
            wheat: { name: 'Wheat', emoji: 'üåæ', seedEmoji: 'üå±', price: 5, sell: 10, growTime: 3 },
            carrot: { name: 'Carrot', emoji: 'ü•ï', seedEmoji: 'üå±', price: 10, sell: 20, growTime: 3 },
            tomato: { name: 'Tomato', emoji: 'üçÖ', seedEmoji: 'üå±', price: 15, sell: 30, growTime: 3 },
            corn: { name: 'Corn', emoji: 'üåΩ', seedEmoji: 'üå±', price: 12, sell: 25, growTime: 3 },
            potato: { name: 'Potato', emoji: 'ü•î', seedEmoji: 'üå±', price: 8, sell: 18, growTime: 3 },
            lettuce: { name: 'Lettuce', emoji: 'ü•¨', seedEmoji: 'üå±', price: 7, sell: 15, growTime: 3 }
        };
        // Multiple fields support
        const numFields = 3;
        const fieldSize = 25;
        let fields = Array(numFields).fill(null).map(() => Array(fieldSize).fill(null));
        let currentField = 0;
        let growthTimers = Array(numFields).fill(null).map(() => Array(fieldSize).fill(0));
        // Inventory and state
        let seeds = { wheat: 3, carrot: 0, tomato: 0, corn: 0, potato: 0, lettuce: 0 };
        let money = 20;
        let harvest = 0;
        let achievements = [];
        let pets = [];
        let characters = [];
        let cosmetics = { hats: [], backgrounds: [], equippedHat: null, equippedBg: null };
        // Orders system
        let orders = [];
        let orderId = 1;

        // Add missing variable declaration for player
        let player = { emoji: 'üßë‚Äçüåæ', pos: 12, energy: 100, maxEnergy: 100 };

        // Generate a new random order
        function generateOrder() {
            // Pick a random crop type
            const cropTypes = Object.keys(crops);
            const type = cropTypes[Math.floor(Math.random() * cropTypes.length)];
            // Amount between 2 and 5
            const amount = Math.floor(Math.random() * 4) + 2;
            // Reward is crop sell price * amount + bonus
            const reward = crops[type].sell * amount + Math.floor(Math.random() * 10 + 5);
            orders.push({ id: orderId++, type, amount, reward });
        }

        // Ensure at least one order exists at all times
        function ensureOrders() {
            if (orders.length === 0) {
                generateOrder();
                renderOrders();
            }
        }

        // Achievements definitions
        const achievementList = [
            { id: 'firstHarvest', name: 'First Harvest', desc: 'Harvest your first crop!', unlock: 'pet', pet: 'üê∂', reward: { money: 10, seeds: { wheat: 2 } } },
            { id: 'wheatMaster', name: 'Wheat Master', desc: 'Harvest 10 wheat!', unlock: 'character', character: { emoji: 'üë©‚Äçüåæ', name: 'Farmer Jill', text: 'Keep up the good work!' }, reward: { money: 30, seeds: { wheat: 3 } } },
            { id: 'carrotKing', name: 'Carrot King', desc: 'Harvest 10 carrots!', unlock: 'pet', pet: 'üê∞', reward: { money: 30, seeds: { carrot: 3 } } },
            { id: 'tomatoTycoon', name: 'Tomato Tycoon', desc: 'Harvest 10 tomatoes!', unlock: 'character', character: { emoji: 'üë®‚Äçüåæ', name: 'Farmer Bob', text: 'Tomatoes are tasty!' }, reward: { money: 30, seeds: { tomato: 3 } } },
            { id: 'hatCollector', name: 'Hat Collector', desc: 'Fulfill 3 orders!', unlock: 'cosmetic', hat: 'üé©', reward: { money: 50 } },
            { id: 'bgMaster', name: 'Background Master', desc: 'Fulfill 5 orders!', unlock: 'cosmetic', background: 'linear-gradient(135deg,#f9d423,#ff4e50)', reward: { money: 100 } }
        ];
        let cropHarvestCount = { wheat: 0, carrot: 0, tomato: 0, corn: 0, potato: 0, lettuce: 0 };
        let ordersFulfilled = 0;

        // Recipes system
        const recipes = [
            { name: 'Salad', ingredients: { lettuce: 2, tomato: 1 }, emoji: 'ü•ó', energy: 30, price: 40 },
            { name: 'Veggie Stew', ingredients: { potato: 1, carrot: 1, corn: 1 }, emoji: 'üç≤', energy: 40, price: 50 },
            { name: 'Bread', ingredients: { wheat: 3 }, emoji: 'üçû', energy: 20, price: 30 },
            { name: 'Fries', ingredients: { potato: 2 }, emoji: 'üçü', energy: 25, price: 35 }
        ];
        let cooked = {};
        recipes.forEach(r => cooked[r.name] = 0);

        // Inventory object to track harvested crops
        let inventory = { wheat: 0, carrot: 0, tomato: 0, corn: 0, potato: 0, lettuce: 0 };
        // Inventory for cooked foods
        let cookedInventory = { Salad: 0, 'Veggie Stew': 0, Bread: 0, Fries: 0 };

        function renderFieldControls() {
            let html = '<b>Fields:</b> ';
            for (let i = 0; i < numFields; i++) {
                html += `<button onclick=\"switchField(${i})\" ${i === currentField ? 'disabled' : ''}>Field ${i+1}</button>`;
            }
            document.getElementById('fieldControls').innerHTML = html;
        }
        function switchField(idx) {
            currentField = idx;
            renderAll();
        }
        function renderField() {
            // Only remove the seed menu if the player has moved off the plot or the menu is not open for the current player position
            const oldMenu = document.getElementById('seedMenu');
            if (oldMenu) {
                // Check if the menu is for the current player position
                const menuPlotIndex = oldMenu.getAttribute('data-plot-index');
                if (menuPlotIndex === null || parseInt(menuPlotIndex) !== player.pos) {
                    oldMenu.remove();
                }
            }
            const fieldDiv = document.getElementById('field');
            fieldDiv.innerHTML = '';
            // Render as a single flex-wrap grid of 25 plots
            for (let i = 0; i < 25; i++) {
                let plot = fields[currentField][i];
                let plotClass = 'plot empty';
                let emoji = 'üü©';
                if (plot) {
                    plotClass = `plot ${plot.type}-${plot.stage}`;
                    if (plot.stage === 'planted') emoji = crops[plot.type].seedEmoji;
                    else if (plot.stage === 'grown') emoji = crops[plot.type].emoji;
                }
                // Show player emoji centered in the plot if player is here
                let content = (i === player.pos)
                    ? `<span style='font-size:32px;display:flex;align-items:center;justify-content:center;width:100%;height:100%;'>${player.emoji}</span>`
                    : emoji;
                const plotDiv = document.createElement('div');
                plotDiv.className = plotClass;
                plotDiv.style.position = 'relative';
                plotDiv.innerHTML = content;
                plotDiv.onclick = function() { plantSeedPrompt(i); };
                fieldDiv.appendChild(plotDiv);
            }
        }
        function renderStats() {
            document.getElementById('stats').innerHTML = `Money: $${money} | ` + Object.keys(seeds).map(type=>`${crops[type].name} Seeds: ${seeds[type]}`).join(' | ') + ` | Total Harvest: ${harvest}`;
        }
        function renderEnergyBar() {
            const percent = Math.max(0, Math.min(100, player.energy / player.maxEnergy * 100));
            document.getElementById('energyBar').innerHTML = `<div class='energy-bar'><div class='energy-fill' style='width:${percent}%;'></div></div>Energy: ${player.energy}/${player.maxEnergy}`;
        }
        function renderShop() {
            let html = '<h3>Seed Shop</h3>';
            Object.keys(crops).forEach(type => {
                html += `<div>${crops[type].name} Seed (${crops[type].seedEmoji}): $${crops[type].price} <button onclick=\"buySeed('${type}')\">Buy</button></div>`;
            });
            document.getElementById('shop').innerHTML = html;
        }
        function renderAchievements() {
            let html = '<h3>Achievements</h3>';
            achievementList.forEach(a => {
                const unlocked = achievements.includes(a.id);
                let rewardText = '';
                if (a.reward) {
                    let rewards = [];
                    if (a.reward.money) rewards.push(`+$${a.reward.money}`);
                    if (a.reward.seeds) {
                        Object.entries(a.reward.seeds).forEach(([type, amt]) => {
                            rewards.push(`+${amt} ${crops[type].name} seeds`);
                        });
                    }
                    rewardText = rewards.length ? ` <span style="color:#43a047;font-size:14px;">[${rewards.join(', ')}]</span>` : '';
                }
                html += `<div>${unlocked ? '‚úÖ' : '‚¨ú'} <b>${a.name}</b>: ${a.desc}${rewardText}</div>`;
            });
            document.getElementById('achievements').innerHTML = html;
        }
        function renderPets() {
            let html = '<h3>Pets</h3>';
            pets.forEach(pet => {
                html += `<span class="pet">${pet}</span>`;
            });
            document.getElementById('pets').innerHTML = html;
        }
        function renderCharacters() {
            let html = '<h3>Characters</h3>';
            characters.forEach(char => {
                html += `<span class="character" onclick=\"talkToCharacter('${char.name}')\">${char.emoji} ${char.name}</span>`;
            });
            document.getElementById('characters').innerHTML = html;
        }
        function renderCosmetics() {
            let html = '<h3>Cosmetics</h3>';
            html += '<div>Hats: ';
            cosmetics.hats.forEach(hat => {
                html += `<span style=\"font-size:28px;cursor:pointer;${cosmetics.equippedHat===hat?'border:2px solid #4caf50;':''}\" onclick=\"equipHat('${hat}')\">${hat}</span> `;
            });
            html += '</div><div>Backgrounds: ';
            cosmetics.backgrounds.forEach(bg => {
                html += `<span style=\"font-size:20px;cursor:pointer;${cosmetics.equippedBg===bg?'border:2px solid #4caf50;':''}\" onclick=\"equipBg('${bg}')\">${bg}</span> `;
            });
            html += '</div>';
            document.getElementById('cosmetics').innerHTML = html;
            if (cosmetics.equippedBg) document.body.style.background = cosmetics.equippedBg;
        }
        function renderOrders() {
            let html = '<h3>Orders</h3>';
            if (orders.length === 0) html += '<div>No orders! <button onclick="generateOrder();renderOrders();">New Order</button></div>';
            orders.forEach(order => {
                html += `<div class="order">Order #${order.id}: ${order.amount} ${crops[order.type].emoji} ${crops[order.type].name} <button onclick=\"fulfillOrder(${order.id})\">Fulfill</button> (Reward: $${order.reward})</div>`;
            });
            document.getElementById('orders').innerHTML = html;
        }
        function renderRecipes() {
            let html = '<h3>Recipes</h3>';
            recipes.forEach(r => {
                let canCook = Object.entries(r.ingredients).every(([type, amt]) => inventory[type] >= amt);
                html += `<div>${r.emoji} <b>${r.name}</b> (${Object.entries(r.ingredients).map(([k,v])=>v+' '+crops[k].emoji).join(', ')}) <button class="${canCook ? 'cook-available' : ''}" onclick="cookRecipe('${r.name}')" ${canCook?'':'disabled'}>Cook</button> (Energy: +${r.energy}, Sell: $${r.price}) Cooked: ${cooked[r.name]}</div>`;
            });
            document.getElementById('recipes').innerHTML = html;
        }

        function showCutscene(html, onClose) {
            document.getElementById('cutsceneContent').innerHTML = html + '<br><br><button onclick="closeCutscene()">Continue</button>';
            cutsceneModal.style.display = 'flex';
            cutsceneModal.onCloseCallback = onClose;
        }
        function closeCutscene() {
            cutsceneModal.style.display = 'none';
            if (typeof cutsceneModal.onCloseCallback === 'function') cutsceneModal.onCloseCallback();
        }

        // Add a new recipe to the recipes list if not already present
        function addRecipe(recipeObj) {
            if (!recipes.some(r => r.name === recipeObj.name)) {
                recipes.push(recipeObj);
                cooked[recipeObj.name] = 0;
                cookedInventory[recipeObj.name] = 0;
            }
        }

        // Check and unlock achievements
        function checkAchievements() {
            achievementList.forEach(a => {
                if (!achievements.includes(a.id)) {
                    let unlocked = false;
                    if (a.id === 'firstHarvest' && harvest >= 1) unlocked = true;
                    if (a.id === 'wheatMaster' && cropHarvestCount.wheat >= 10) unlocked = true;
                    if (a.id === 'carrotKing' && cropHarvestCount.carrot >= 10) unlocked = true;
                    if (a.id === 'tomatoTycoon' && cropHarvestCount.tomato >= 10) unlocked = true;
                    if (a.id === 'hatCollector' && ordersFulfilled >= 3) unlocked = true;
                    if (a.id === 'bgMaster' && ordersFulfilled >= 5) unlocked = true;
                    if (unlocked) {
                        achievements.push(a.id);
                        if (a.unlock === 'pet') pets.push(a.pet);
                        if (a.unlock === 'character') {
                            characters.push(a.character);
                            // Show cutscene for new character
                            if (a.character.name === 'Farmer Jill') {
                                showCutscene(`<span style='font-size:32px;'>${a.character.emoji}</span><br><b>${a.character.name}</b><br><br>Welcome to the farm! I'm here to help you become a great farmer.<br><br>Here, take my special recipe for <b>Berry Pie</b>!`, function() {
                                    addRecipe({ name: 'Berry Pie', ingredients: { wheat: 2, tomato: 1 }, emoji: 'ü•ß', energy: 35, price: 45 });
                                    showNotification('New recipe unlocked: Berry Pie!');
                                    renderRecipes();
                                });
                            } else if (a.character.name === 'Farmer Bob') {
                                showCutscene(`<span style='font-size:32px;'>${a.character.emoji}</span><br><b>${a.character.name}</b><br><br>Tomatoes are tasty! Keep growing and I'll share more tips soon.`);
                            }
                        }
                        if (a.id === 'firstHarvest') {
                            // Unlock Farmer Jill after first harvest (if not already in characters)
                            if (!characters.some(c => c.name === 'Farmer Jill')) {
                                characters.push({ emoji: 'üë©\u200düåæ', name: 'Farmer Jill', text: 'Welcome to the farm! I\'m here to help.' });
                                showCutscene(`<span style='font-size:32px;'>üë©‚Äçüåæ</span><br><b>Farmer Jill</b><br><br>Welcome to the farm! I'm here to help you become a great farmer.<br><br>Here, take my special recipe for <b>Berry Pie</b>!`, function() {
                                    addRecipe({ name: 'Berry Pie', ingredients: { wheat: 2, tomato: 1 }, emoji: 'ü•ß', energy: 35, price: 45 });
                                    showNotification('New recipe unlocked: Berry Pie!');
                                    renderRecipes();
                                });
                            }
                        }
                        if (a.unlock === 'cosmetic' && a.hat) cosmetics.hats.push(a.hat);
                        if (a.unlock === 'cosmetic' && a.background) cosmetics.backgrounds.push(a.background);
                        // Grant rewards and show a single notification
                        let rewardMsg = `Achievement unlocked: ${a.name}!`;
                        if (a.reward) {
                            let rewards = [];
                            if (a.reward.money) {
                                money += a.reward.money;
                                rewards.push(`+$${a.reward.money}`);
                            }
                            if (a.reward.seeds) {
                                Object.entries(a.reward.seeds).forEach(([type, amt]) => {
                                    seeds[type] = (seeds[type] || 0) + amt;
                                    rewards.push(`+${amt} ${crops[type].name} seeds`);
                                });
                            }
                            if (rewards.length) rewardMsg += ' ' + rewards.join(', ');
                        }
                        showNotification(rewardMsg);
                    }
                }
            });
            renderAchievements();
            renderPets();
            renderCharacters();
            renderCosmetics();
        }

        // Planting with energy and player position (now with selection menu)
        function plantSeedPrompt(index) {
            if (fields[currentField][index] || player.energy < 5 || player.pos !== index) return;
            let options = Object.keys(crops).filter(type => seeds[type] > 0);
            if (options.length === 0) { alert('No seeds! Buy some in the shop.'); return; }
            // Show a menu below the plot for seed selection
            showSeedMenu(index, options);
        }
        function showSeedMenu(index, options) {
            // Remove any existing menu
            let oldMenu = document.getElementById('seedMenu');
            if (oldMenu) oldMenu.remove();
            // Find the plot div
            const fieldDiv = document.getElementById('field');
            const plotDivs = fieldDiv.querySelectorAll('.plot');
            const plotDiv = plotDivs[index];
            // Create menu
            const menu = document.createElement('div');
            menu.id = 'seedMenu';
            menu.setAttribute('data-plot-index', index);
            menu.style.position = 'absolute';
            menu.style.background = '#fff';
            menu.style.border = '1px solid #aaa';
            menu.style.borderRadius = '6px';
            menu.style.padding = '6px';
            menu.style.zIndex = 10;
            menu.style.top = (plotDiv.offsetTop + 70) + 'px';
            menu.style.left = (plotDiv.offsetLeft - 10) + 'px';
            options.forEach(type => {
                const btn = document.createElement('button');
                btn.textContent = crops[type].seedEmoji + ' ' + crops[type].name;
                btn.onclick = function() {
                    seeds[type]--;
                    fields[currentField][index] = { type: type, stage: 'planted', watered: false };
                    growthTimers[currentField][index] = 0;
                    player.energy -= 5;
                    menu.remove();
                    renderField();
                    renderStats();
                    renderEnergyBar();
                };
                menu.appendChild(btn);
            });
            // Add cancel button
            const cancel = document.createElement('button');
            cancel.textContent = 'Cancel';
            cancel.onclick = function() { menu.remove(); };
            menu.appendChild(cancel);
            // Add to container
            document.querySelector('.container').appendChild(menu);
        }
        function renderInventory() {
            let html = '<h3>Inventory</h3>';
            html += '<div><b>Crops:</b> ';
            html += Object.keys(inventory).map(type => `${crops[type].emoji} ${crops[type].name}: ${inventory[type]}`).join(' | ');
            html += '</div>';
            html += '<div style="margin-top:8px;"><b>Cooked Food:</b> ';
            html += Object.keys(cookedInventory).map(name => `${recipes.find(r=>r.name===name)?.emoji||''} ${name}: ${cookedInventory[name]}`).join(' | ');
            html += '</div>';
            document.getElementById('inventory').innerHTML = html;
        }
        function renderSellBin() {
            let html = '<h3>Sell Bin</h3>';
            let hasCrops = false;
            html += '<div style="margin-bottom:8px;">Sell your harvested crops for money!</div>';
            Object.keys(inventory).forEach(type => {
                if (inventory[type] > 0) {
                    hasCrops = true;
                    html += `<div style='margin-bottom:6px;'>${crops[type].emoji} <b>${crops[type].name}</b>: ${inventory[type]} 
                        <input type='number' id='sellQty_${type}' min='1' max='${inventory[type]}' value='1' style='width:50px;'>
                        <button onclick="sellCrop('${type}')">Sell ($${crops[type].sell} each)</button></div>`;
                }
            });
            if (!hasCrops) {
                html += '<div style="color:#888;">No crops to sell!</div>';
            }
            const el = document.getElementById('sellBin');
            if (el) {
                el.innerHTML = html;
                el.style.display = 'block';
            } else {
                // If the element doesn't exist, create it
                const div = document.createElement('div');
                div.id = 'sellBin';
                div.className = 'sell-bin';
                div.innerHTML = html;
                document.querySelector('.container').appendChild(div);
            }
        }
        // Add sellCrop function
        typeof window.sellCrop !== 'undefined' && (window.sellCrop = undefined);
        function sellCrop(type) {
            const qtyInput = document.getElementById('sellQty_' + type);
            let qty = parseInt(qtyInput.value);
            if (isNaN(qty) || qty < 1) qty = 1;
            if (qty > inventory[type]) qty = inventory[type];
            if (qty < 1) return;
            inventory[type] -= qty;
            money += qty * crops[type].sell;
            showNotification(`Sold ${qty} ${crops[type].emoji} ${crops[type].name} for $${qty * crops[type].sell}!`);
            renderStats();
            renderInventory();
            renderSellBin();
        }
        // Update Show Sell Bin button to toggle sell bin visibility
        function showSellBin() {
            const el = document.getElementById('sellBin');
            if (el && el.style.display !== 'none') {
                el.style.display = 'none';
            } else {
                renderSellBin();
                if (el) el.style.display = 'block';
            }
        }
        // Add Rest button to controls
function renderRestButton() {
    let html = '<button id="restBtn" onclick="startRest()">Rest (6 sec)</button>';
    html += '<span id="restCountdown" style="margin-left:12px;color:#888;font-size:15px;"></span>';
    const controls = document.querySelectorAll('.controls')[0];
    if (controls && !document.getElementById('restBtn')) {
        controls.insertAdjacentHTML('beforeend', html);
    }
}
// Add rest logic
typeof window._restTimeout !== 'undefined' && clearTimeout(window._restTimeout);
typeof window._restInterval !== 'undefined' && clearInterval(window._restInterval);
let isResting = false;
function startRest() {
    if (isResting) return;
    isResting = true;
    const restBtn = document.getElementById('restBtn');
    const restCountdown = document.getElementById('restCountdown');
    if (restBtn) restBtn.disabled = true;
    let seconds = 6; // Changed from 6 * 60 to 6 seconds
    function updateCountdown() {
        let min = Math.floor(seconds / 60);
        let sec = seconds % 60;
        restCountdown.textContent = `Resting: ${min}:${sec.toString().padStart(2, '0')}`;
    }
    updateCountdown();
    window._restInterval = setInterval(() => {
        seconds--;
        updateCountdown();
        if (seconds <= 0) {
            clearInterval(window._restInterval);
        }
    }, 1000);
    window._restTimeout = setTimeout(() => {
        isResting = false;
        player.energy = player.maxEnergy;
        showNotification('You feel fully rested! Energy restored.');
        if (restBtn) restBtn.disabled = false;
        if (restCountdown) restCountdown.textContent = '';
        renderEnergyBar();
    }, 6000); // 6 seconds
}
        function renderAll() {
            renderStats();
            renderEnergyBar();
            renderFieldControls();
            renderField();
            renderShop();
            renderOrders();
            renderRecipes();
            renderAchievements();
            renderPets();
            renderCharacters();
            renderCosmetics();
            renderInventory();
            renderSellBin();
            renderAvatarAndPetControls();
            renderRestButton();
        }
        // --- MOVEMENT FIX ---
        function movePlayer(direction) {
            // 5x5 grid, pos 0-24
            let row = Math.floor(player.pos / 5);
            let col = player.pos % 5;
            let newRow = row;
            let newCol = col;
            if (direction === 'left' && col > 0) newCol = col - 1;
            else if (direction === 'right' && col < 4) newCol = col + 1;
            else if (direction === 'up' && row > 0) newRow = row - 1;
            else if (direction === 'down' && row < 4) newRow = row + 1;
            // Only move if the new position is adjacent
            if (newRow !== row || newCol !== col) {
                player.pos = newRow * 5 + newCol;
                renderField();
            }
        }
        // --- END MOVEMENT FIX ---
        // --- TUTORIAL FIX ---
        function showTutorial(force) {
            if (!localStorage.getItem('tutorialShown') || force) {
                const jillEmoji = 'üë©‚Äçüåæ';
                const jillName = 'Farmer Jill';
                // Build avatar picker HTML
                let avatarHtml = '<div id="emojiPicker" style="margin:16px 0;">';
                playerEmojis.forEach(e => {
                    avatarHtml += `<button type='button' style='font-size:28px;${player.emoji===e?'border:2px solid #2196f3;':''}' data-emoji='${e}'>${e}</button>`;
                });
                avatarHtml += '</div>';
                // Farmer Jill's tutorial message
                const tutorialHtml = `
                    <div style='font-size:32px;'>${jillEmoji}</div>
                    <b>${jillName}</b>
                    <p style='font-size:18px;'>Howdy, new farmer! I'm Farmer Jill, and I'll show you the ropes.</p>
                    <ul style='text-align:left;font-size:17px;'>
                        <li>Use <b>WASD</b> or <b>arrow keys</b> to move your character.</li>
                        <li>Click a plot (where your character is standing) to plant seeds.</li>
                        <li>Water crops with the <b>Water Crops</b> button.</li>
                        <li>Harvest grown crops with the <b>Harvest Crops</b> button.</li>
                        <li>Buy more seeds in the <b>Seed Shop</b>.</li>
                        <li>Fulfill orders and unlock achievements!</li>
                    </ul>
                    <p style='font-size:17px;'>But first, pick your farmer avatar:</p>
                    ${avatarHtml}
                    <div id='avatarError' style='color:#c00;font-size:15px;display:none;margin-bottom:8px;'>Please select an avatar to continue.</div>
                    <button id='continueTutorialBtn' disabled style='margin-top:10px;'>Continue</button>
                `;
                document.getElementById('cutsceneContent').innerHTML = tutorialHtml;
                cutsceneModal.style.display = 'flex';
                // Attach picker events
                setTimeout(attachAvatarPickerEvents, 100);
                function attachAvatarPickerEvents() {
                    const picker = document.getElementById('emojiPicker');
                    if (!picker) return;
                    Array.from(picker.querySelectorAll('button')).forEach(btn => {
                        btn.onclick = function(e) {
                            player.emoji = btn.getAttribute('data-emoji');
                            Array.from(picker.querySelectorAll('button')).forEach(b => b.style.border = '');
                            btn.style.border = '2px solid #2196f3';
                            document.getElementById('avatarError').style.display = 'none';
                            document.getElementById('continueTutorialBtn').disabled = false;
                        };
                    });
                }
                document.getElementById('continueTutorialBtn').onclick = function() {
                    if (!player.emoji || player.emoji === '') {
                        document.getElementById('avatarError').style.display = 'block';
                        return;
                    }
                    localStorage.setItem('tutorialShown', 'true');
                    cutsceneModal.style.display = 'none';
                    renderAll();
                };
            } else {
                renderAll();
            }
        }
        // --- END TUTORIAL FIX ---
        // --- RESET TUTORIAL BUTTON FOR TESTING ---
        window.resetTutorial = function() {
            localStorage.removeItem('tutorialShown');
            showTutorial(true);
        };
        // --- END RESET ---
        // --- ARROW KEY SUPPORT ---
        // Only one event listener for movement to ensure one step per key press
        if (window._movementListener) document.removeEventListener('keydown', window._movementListener);
        window._movementListener = function(e) {
            if (e.key === 'a' || e.key === 'A' || e.key === 'ArrowLeft') movePlayer('left');
            else if (e.key === 'd' || e.key === 'D' || e.key === 'ArrowRight') movePlayer('right');
            else if (e.key === 'w' || e.key === 'W' || e.key === 'ArrowUp') movePlayer('up');
            else if (e.key === 's' || e.key === 'S' || e.key === 'ArrowDown') movePlayer('down');
        };
        document.addEventListener('keydown', window._movementListener);
        // --- END ARROW KEY SUPPORT ---
        // --- ENSURE TUTORIAL ON LOAD ---
        window.addEventListener('DOMContentLoaded', function() {
            animateProgressBar();
            showTutorial();
            checkAchievements();
            renderRestButton();
        });
        // Initial render
        renderAll();
        function showNotification(msg) {
            const n = document.getElementById('notification');
            n.textContent = msg;
            n.style.display = 'block';
            n.style.opacity = '1';
            setTimeout(() => { n.style.opacity = '0'; }, 1200);
            setTimeout(() => { n.style.display = 'none'; }, 1600);
        }
        function buySeed(type) {
            if (money >= crops[type].price) {
                money -= crops[type].price;
                seeds[type]++;
                showNotification(`Purchased 1 ${crops[type].name} seed!`);
                renderStats();
                renderShop();
            } else {
                showNotification('Not enough money!');
            }
        }
        // Water animation for each plot
        function animateWaterDropletOnPlot(plotIndex) {
            const fieldDiv = document.getElementById('field');
            const plotDivs = fieldDiv.querySelectorAll('.plot');
            const plotDiv = plotDivs[plotIndex];
            if (!plotDiv) return;
            const droplet = document.createElement('span');
            droplet.textContent = 'üíß';
            droplet.style.position = 'absolute';
            droplet.style.left = '50%';
            droplet.style.top = '10%';
            droplet.style.transform = 'translate(-50%, 0)';
            droplet.style.fontSize = '28px';
            droplet.style.opacity = '1';
            droplet.style.transition = 'top 0.7s cubic-bezier(.4,2,.6,1), opacity 0.7s';
            plotDiv.appendChild(droplet);
            setTimeout(() => {
                droplet.style.top = '-30px';
                droplet.style.opacity = '0';
            }, 30);
            setTimeout(() => {
                droplet.remove();
            }, 800);
        }

        // Water all crops in the current field
        function waterCrops() {
            let watered = false;
            for (let i = 0; i < fieldSize; i++) {
                let plot = fields[currentField][i];
                if (plot && plot.stage === 'planted' && !plot.watered) {
                    plot.watered = true;
                    watered = true;
                    animateWaterDropletOnPlot(i);
                }
            }
            renderField();
            if (watered) {
                showNotification('Crops watered!');
            } else {
                showNotification('No crops to water!');
            }
        }

        // Grow crops over time (simulate growth for demo)
function growCrops() {
    let anyGrown = false;
    for (let i = 0; i < fieldSize; i++) {
        let plot = fields[currentField][i];
        if (plot && plot.stage === 'planted' && plot.watered) {
            growthTimers[currentField][i]++;
            if (growthTimers[currentField][i] >= crops[plot.type].growTime) {
                plot.stage = 'grown';
                plot.watered = false;
                animateSparkleOnPlot(i);
                showNotification(`${crops[plot.type].name} is fully grown!`);
                anyGrown = true;
            }
        }
    }
    renderField();
    return anyGrown;
}

// Add a global interval to grow crops every second
typeof window._growCropsInterval !== 'undefined' && clearInterval(window._growCropsInterval);
window._growCropsInterval = setInterval(growCrops, 1000);

        // Remove old growCrops interval logic if present
        // Add a global crop growth timer (every 1 second)
        if (window._cropGrowthInterval) clearInterval(window._cropGrowthInterval);
        window._cropGrowthInterval = setInterval(function() {
            for (let f = 0; f < numFields; f++) {
                for (let i = 0; i < fieldSize; i++) {
                    let plot = fields[f][i];
                    if (plot && plot.stage === 'planted' && plot.watered) {
                        growthTimers[f][i] = (growthTimers[f][i] || 0) + 1;
                        if (growthTimers[f][i] >= crops[plot.type].growTime) {
                            plot.stage = 'grown';
                            plot.watered = false;
                            animateSparkleOnPlot && animateSparkleOnPlot(i);
                            if (f === currentField) renderField();
                            showNotification(`${crops[plot.type].emoji} ${crops[plot.type].name} is fully grown!`);
                        }
                    }
                }
            }
<<<<<<< HEAD
            renderField();
            return anyGrown;
        }

        // Harvest all grown crops in the current field
        function harvestCrops() {
            let harvested = false;
            for (let i = 0; i < fieldSize; i++) {
                let plot = fields[currentField][i];
                if (plot && plot.stage === 'grown') {
                    cropHarvestCount[plot.type] = (cropHarvestCount[plot.type] || 0) + 1;
                    inventory[plot.type] = (inventory[plot.type] || 0) + 1;
                    harvest++;
                    fields[currentField][i] = null;
                    harvested = true;
                }
            }
            renderField();
            renderStats();
            renderInventory();
            renderSellBin();
            renderRecipes();
            if (harvested) {
                showNotification('Crops harvested!');
                // Always check achievements after a successful harvest
                checkAchievements();
            } else {
                showNotification('No crops to harvest!');
            }
        }

        // Update fulfillOrder to check achievements (if not already present)
        function fulfillOrder(id) {
            const idx = orders.findIndex(o => o.id === id);
            if (idx === -1) return;
            const order = orders[idx];
            if (inventory[order.type] >= order.amount) {
                inventory[order.type] -= order.amount;
                money += order.reward;
                ordersFulfilled++;
                orders.splice(idx, 1);
                showNotification('Order fulfilled!');
                renderStats();
                renderOrders();
                renderInventory();
                renderSellBin();
                checkAchievements();
                // Generate a new order if none left
                ensureOrders();
            } else {
                showNotification('Not enough crops to fulfill order!');
            }
        }
        // Planting with energy and player position (now with selection menu)
        function plantSeedPrompt(index) {
            if (fields[currentField][index] || player.energy < 5 || player.pos !== index) return;
            let options = Object.keys(crops).filter(type => seeds[type] > 0);
            if (options.length === 0) { alert('No seeds! Buy some in the shop.'); return; }
            // Show a menu below the plot for seed selection
            showSeedMenu(index, options);
        }
        function showSeedMenu(index, options) {
            // Remove any existing menu
            let oldMenu = document.getElementById('seedMenu');
            if (oldMenu) oldMenu.remove();
            // Find the plot div
            const fieldDiv = document.getElementById('field');
            const plotDivs = fieldDiv.querySelectorAll('.plot');
            const plotDiv = plotDivs[index];
            // Create menu
            const menu = document.createElement('div');
            menu.id = 'seedMenu';
            menu.setAttribute('data-plot-index', index);
            menu.style.position = 'absolute';
            menu.style.background = '#fff';
            menu.style.border = '1px solid #aaa';
            menu.style.borderRadius = '6px';
            menu.style.padding = '6px';
            menu.style.zIndex = 10;
            menu.style.top = (plotDiv.offsetTop + 70) + 'px';
            menu.style.left = (plotDiv.offsetLeft - 10) + 'px';
            options.forEach(type => {
                const btn = document.createElement('button');
                btn.textContent = crops[type].seedEmoji + ' ' + crops[type].name;
                btn.onclick = function() {
                    seeds[type]--;
                    fields[currentField][index] = { type: type, stage: 'planted', watered: false };
                    growthTimers[currentField][index] = 0;
                    player.energy -= 5;
                    menu.remove();
                    renderField();
                    renderStats();
                    renderEnergyBar();
                };
                menu.appendChild(btn);
            });
            // Add cancel button
            const cancel = document.createElement('button');
            cancel.textContent = 'Cancel';
            cancel.onclick = function() { menu.remove(); };
            menu.appendChild(cancel);
            // Add to container
            document.querySelector('.container').appendChild(menu);
        }
        function renderAll() {
            renderStats();
            renderEnergyBar();
            renderFieldControls();
            renderField();
            renderShop();
            renderOrders();
            renderRecipes();
            renderAchievements();
            renderPets();
            renderCharacters();
            renderCosmetics();
            renderInventory();
            renderSellBin();
            renderAvatarAndPetControls();
            renderRestButton();
        }
        // Keyboard controls for player movement (WASD only)
        // (Removed duplicate event listener to prevent double movement)
        // --- ENSURE TUTORIAL ON LOAD ---
        window.addEventListener('DOMContentLoaded', function() {
            animateProgressBar();
            showTutorial();
            checkAchievements();
        });
        // Initial render
        renderAll();
        function showNotification(msg) {
            const n = document.getElementById('notification');
            n.textContent = msg;
            n.style.display = 'block';
            n.style.opacity = '1';
            setTimeout(() => { n.style.opacity = '0'; }, 1200);
            setTimeout(() => { n.style.display = 'none'; }, 1600);
        }
        function buySeed(type) {
            if (money >= crops[type].price) {
                money -= crops[type].price;
                seeds[type]++;
                showNotification(`Purchased 1 ${crops[type].name} seed!`);
                renderStats();
                renderShop();
            } else {
                showNotification('Not enough money!');
            }
        }
        // Water animation for each plot
        function animateWaterDropletOnPlot(plotIndex) {
            const fieldDiv = document.getElementById('field');
            const plotDivs = fieldDiv.querySelectorAll('.plot');
            const plotDiv = plotDivs[plotIndex];
            if (!plotDiv) return;
            const droplet = document.createElement('span');
            droplet.textContent = 'üíß';
            droplet.style.position = 'absolute';
            droplet.style.left = '50%';
            droplet.style.top = '10%';
            droplet.style.transform = 'translate(-50%, 0)';
            droplet.style.fontSize = '28px';
            droplet.style.opacity = '1';
            droplet.style.transition = 'top 0.7s cubic-bezier(.4,2,.6,1), opacity 0.7s';
            plotDiv.appendChild(droplet);
            setTimeout(() => {
                droplet.style.top = '-30px';
                droplet.style.opacity = '0';
            }, 30);
            setTimeout(() => {
                droplet.remove();
            }, 800);
        }

        // Water all crops in the current field
        function waterCrops() {
            let watered = false;
            for (let i = 0; i < fieldSize; i++) {
                let plot = fields[currentField][i];
                if (plot && plot.stage === 'planted' && !plot.watered) {
                    plot.watered = true;
                    watered = true;
                    animateWaterDropletOnPlot(i);
                }
            }
            renderField();
            if (watered) {
                showNotification('Crops watered!');
            } else {
                showNotification('No crops to water!');
            }
        }

        // Grow crops over time (simulate growth for demo)
        function growCrops() {
            let anyGrown = false;
            for (let i = 0; i < fieldSize; i++) {
                let plot = fields[currentField][i];
                if (plot && plot.stage === 'planted' && plot.watered) {
                    growthTimers[currentField][i]++;
                    if (growthTimers[currentField][i] >= crops[plot.type].growTime) {
                        plot.stage = 'grown';
                        plot.watered = false;
                        animateSparkleOnPlot(i);
                        showNotification(`${crops[plot.type].name} is fully grown!`);
                        anyGrown = true;
                    }
                }
            }
            renderField();
            return anyGrown;
        }
=======
        }, 1000);
>>>>>>> 2276a0061536d728ac5285374eac0ca171200a27

        // Harvest all grown crops in the current field
        function harvestCrops() {
            let harvested = false;
            for (let i = 0; i < fieldSize; i++) {
                let plot = fields[currentField][i];
                if (plot && plot.stage === 'grown') {
                    cropHarvestCount[plot.type] = (cropHarvestCount[plot.type] || 0) + 1;
                    inventory[plot.type] = (inventory[plot.type] || 0) + 1;
                    harvest++;
                    fields[currentField][i] = null;
                    harvested = true;
                }
            }
            renderField();
            renderStats();
            renderInventory();
            renderSellBin();
            renderRecipes();
            if (harvested) {
                showNotification('Crops harvested!');
                // Always check achievements after a successful harvest
                checkAchievements();
            } else {
                showNotification('No crops to harvest!');
            }
        }

        // Cook a recipe if enough ingredients in inventory
        function cookRecipe(recipeName) {
            const recipe = recipes.find(r => r.name === recipeName);
            if (!recipe) return;
            // Check if enough ingredients in inventory
            let canCook = Object.entries(recipe.ingredients).every(([type, amt]) => inventory[type] >= amt);
            if (!canCook) {
                showNotification('Not enough ingredients!');
                return;
            }
            // Deduct ingredients
            Object.entries(recipe.ingredients).forEach(([type, amt]) => {
                inventory[type] -= amt;
            });
            cooked[recipe.name] = (cooked[recipe.name] || 0) + 1;
            cookedInventory[recipe.name] = (cookedInventory[recipe.name] || 0) + 1;
            renderStats();
            renderEnergyBar();
            renderInventory();
            renderSellBin();
            renderRecipes();
            // Show modal to eat or sell
            showCookedFoodChoice(recipe);
        }

        function showCookedFoodChoice(recipe) {
            const modalHtml = `
                <div style='font-size:32px;'>${recipe.emoji}</div>
                <b>${recipe.name}</b>
                <p>What would you like to do with your freshly cooked <b>${recipe.name}</b>?</p>
                <button id='eatCookedBtn' style='margin:8px 0 0 0;'>Eat (+${recipe.energy} energy)</button><br>
                <button id='sellCookedBtn' style='margin:8px 0 0 0;'>Sell (+$${recipe.price})</button>
            `;
            document.getElementById('cutsceneContent').innerHTML = modalHtml;
            cutsceneModal.style.display = 'flex';
            document.getElementById('eatCookedBtn').onclick = function() {
                if (cookedInventory[recipe.name] > 0) {
                    cookedInventory[recipe.name]--;
                    player.energy = Math.min(player.maxEnergy, player.energy + recipe.energy);
                    showNotification(`Ate ${recipe.emoji} ${recipe.name}! (+${recipe.energy} energy)`);
                    cutsceneModal.style.display = 'none';
                    renderEnergyBar();
                    renderInventory();
                }
            };
            document.getElementById('sellCookedBtn').onclick = function() {
                if (cookedInventory[recipe.name] > 0) {
                    cookedInventory[recipe.name]--;
                    money += recipe.price;
                    showNotification(`Sold ${recipe.emoji} ${recipe.name}! (+$${recipe.price})`);
                    cutsceneModal.style.display = 'none';
                    renderStats();
                    renderInventory();
                    renderSellBin();
                }
            };
        }
        function renderAvatarAndPetControls() {
            let html = '<h3>Avatar & Pet</h3>';
            // Avatar selection
            html += '<div><b>Avatar:</b> ';
            playerEmojis.forEach(e => {
                html += `<span style="font-size:28px;cursor:pointer;${player.emoji===e?'border:2px solid #2196f3;':''}" onclick="changeAvatar('${e}')">${e}</span> `;
            });
            html += '</div>';
            // Pet equipping
            html += '<div style="margin-top:10px;"><b>Pet:</b> ';
            if (pets.length === 0) {
                html += '<span style="color:#888;">(No pets unlocked)</span>';
            } else {
                pets.forEach(pet => {
                    html += `<span style="font-size:28px;cursor:pointer;${player.equippedPet===pet?'border:2px solid #43a047;':''}" onclick="equipPet('${pet}')">${pet}</span> `;
                });
                html += `<span style="font-size:16px;margin-left:8px;cursor:pointer;color:#888;" onclick="equipPet(null)">(Unequip)</span>`;
            }
            html += '</div>';
            document.getElementById('avatarPetControls').innerHTML = html;
        }

        function changeAvatar(emoji) {
            player.emoji = emoji;
            renderAll();
        }
        function equipPet(pet) {
            player.equippedPet = pet;
            renderAll();
        }

        // Fix: Add missing animateSparkleOnPlot for grown crops
        function animateSparkleOnPlot(plotIndex) {
            const fieldDiv = document.getElementById('field');
            const plotDivs = fieldDiv.querySelectorAll('.plot');
            const plotDiv = plotDivs[plotIndex];
            if (!plotDiv) return;
            const sparkle = document.createElement('span');
            sparkle.textContent = '‚ú®';
            sparkle.style.position = 'absolute';
            sparkle.style.left = '50%';
            sparkle.style.top = '10%';
            sparkle.style.transform = 'translate(-50%, 0)';
            sparkle.style.fontSize = '28px';
            sparkle.style.opacity = '1';
            sparkle.style.transition = 'top 0.7s, opacity 0.7s';
            plotDiv.appendChild(sparkle);
            setTimeout(() => {
                sparkle.style.top = '-30px';
                sparkle.style.opacity = '0';
            }, 30);
            setTimeout(() => {
                sparkle.remove();
            }, 800);
        }

        // Show Farmer Jill tutorial and avatar picker on first visit
        function showTutorial() {
            if (!localStorage.getItem('tutorialShown')) {
                // Farmer Jill's emoji and name
                const jillEmoji = 'üë©‚Äçüåæ';
                const jillName = 'Farmer Jill';
                // Build avatar picker HTML
                let avatarHtml = '<div id="emojiPicker" style="margin:16px 0;">';
                playerEmojis.forEach(e => {
                    avatarHtml += `<button type='button' style='font-size:28px;${player.emoji===e?'border:2px solid #2196f3;':''}' data-emoji='${e}'>${e}</button>`;
                });
                avatarHtml += '</div>';
                // Farmer Jill's tutorial message
                const tutorialHtml = `
                    <div style='font-size:32px;'>${jillEmoji}</div>
                    <b>${jillName}</b>
                    <p style='font-size:18px;'>Howdy, new farmer! I'm Farmer Jill, and I'll show you the ropes.</p>
                    <ul style='text-align:left;font-size:17px;'>
                        <li>Use <b>WASD</b> or <b>arrow keys</b> to move your character.</li>
                        <li>Click a plot (where your character is standing) to plant seeds.</li>
                        <li>Water crops with the <b>Water Crops</b> button.</li>
                        <li>Harvest grown crops with the <b>Harvest Crops</b> button.</li>
                        <li>Buy more seeds in the <b>Seed Shop</b>.</li>
                        <li>Fulfill orders and unlock achievements!</li>
                    </ul>
                    <p style='font-size:17px;'>But first, pick your farmer avatar:</p>
                    ${avatarHtml}
                    <div id='avatarError' style='color:#c00;font-size:15px;display:none;margin-bottom:8px;'>Please select an avatar to continue.</div>
                    <button id='continueTutorialBtn' disabled style='margin-top:10px;'>Continue</button>
                `;
                document.getElementById('cutsceneContent').innerHTML = tutorialHtml;
                cutsceneModal.style.display = 'flex';
                // Attach picker events
                setTimeout(attachAvatarPickerEvents, 100);
                function attachAvatarPickerEvents() {
                    const picker = document.getElementById('emojiPicker');
                    if (!picker) return;
                    Array.from(picker.querySelectorAll('button')).forEach(btn => {
                        btn.onclick = function(e) {
                            player.emoji = btn.getAttribute('data-emoji');
                            Array.from(picker.querySelectorAll('button')).forEach(b => b.style.border = '');
                            btn.style.border = '2px solid #2196f3';
                            document.getElementById('avatarError').style.display = 'none';
                            document.getElementById('continueTutorialBtn').disabled = false;
                        };
                    });
                }
                document.getElementById('continueTutorialBtn').onclick = function() {
                    if (!player.emoji || player.emoji === '') {
                        document.getElementById('avatarError').style.display = 'block';
                        return;
                    }
                    localStorage.setItem('tutorialShown', 'true');
                    cutsceneModal.style.display = 'none';
                    renderAll();
                };
            } else {
                renderAll();
            }
        }
        // --- INTRO MODAL LOGIC ---
    const introModal = document.getElementById('introModal');
    const avatarChoicesDiv = document.getElementById('avatarChoices');
    const startGameBtn = document.getElementById('startGameBtn');
    let selectedAvatar = null;
    // Show avatar options
    playerEmojis.forEach(emoji => {
      const btn = document.createElement('button');
      btn.textContent = emoji;
      btn.style.fontSize = '28px';
      btn.onclick = function() {
        selectedAvatar = emoji;
        // Highlight selected
        Array.from(avatarChoicesDiv.children).forEach(b => b.style.border = '');
        btn.style.border = '2px solid #4caf50';
        startGameBtn.disabled = false;
      };
      avatarChoicesDiv.appendChild(btn);
    });
    startGameBtn.onclick = function() {
      if (selectedAvatar) {
        player.emoji = selectedAvatar;
        introModal.style.display = 'none';
        renderAll();
      }
    };
    // Prevent interaction with game until avatar is chosen
    window.addEventListener('DOMContentLoaded', function() {
      introModal.style.display = 'flex';
    });
    // Add a global interval to grow crops every second
    if (window._growCropsInterval) clearInterval(window._growCropsInterval);
    window._growCropsInterval = setInterval(growCrops, 1000);
    </script>
</body>
</html>
